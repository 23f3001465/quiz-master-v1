{% extends "ubase.htm" %}
{% block title %}My Profile{% endblock %}

{% block content %}
<div class="row">
<div class="col-12">
<div class="d-flex justify-content-between align-items-center mb-4">
<h1>My Profile</h1>
</div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div class="card">
<div class="card-header bg-primary text-white">
<h5 class="mb-0">Profile Information</h5>
</div>
<div class="card-body text-center">
<div class="mb-3">
<i class="fas fa-user-circle fa-5x text-primary"></i>
</div>
<h4>{{ current_user.full_name }}</h4>
<p class="text-muted">{{ current_user.qualification }}</p>

<div class="mt-4">
<p><i class="fas fa-envelope me-2"></i> {{ current_user.email }}</p>
<p><i class="fas fa-phone me-2"></i> {{ current_user.phone }}</p>
<p><i class="fas fa-map-marker-alt me-2"></i> {{ current_user.address }}</p>
<p><i class="fas fa-calendar-alt me-2"></i> DOB: {{ current_user.dob.strftime('%d-%m-%Y') }}</p>
</div>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card">
<div class="card-header bg-success text-white">
<h5 class="mb-0">Performance Overview</h5>
</div>
<div class="card-body">
<canvas id="performanceChart" height="250"></canvas>
</div>
</div>

<div class="card mt-4">
<div class="card-header bg-info text-white">
<h5 class="mb-0">Account Information</h5>
</div>
<div class="card-body">
<div class="row">
<div class="col-md-6">
<p><strong>Username:</strong> {{ current_user.username }}</p>
<p><strong>Account Status:</strong> 
<span class="badge bg-{{ 'success' if current_user.status == 'active' else 'danger' }}">
{{ current_user.status }}
</span>
</p>
</div>
<div class="col-md-6">
<p><strong>Account Type:</strong> {{ 'Administrator' if current_user.is_admin else 'Student' }}</p>
<p><strong>User ID:</strong> {{ current_user.user_id }}</p>
</div>
</div>

<div class="mt-3">
<button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
<i class="fas fa-key"></i> Change Password
</button>
</div>
</div>
</div>
</div>
</div>

<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header bg-warning text-white">
<h5 class="modal-title">Change Password</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<form id="changePasswordForm">
<div class="mb-3">
<label for="currentPassword" class="form-label">Current Password</label>
<input type="password" class="form-control" id="currentPassword" required>
</div>
<div class="mb-3">
<label for="newPassword" class="form-label">New Password</label>
<input type="password" class="form-control" id="newPassword" required>
</div>
<div class="mb-3">
<label for="confirmPassword" class="form-label">Confirm New Password</label>
<input type="password" class="form-control" id="confirmPassword" required>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button type="button" class="btn btn-primary" id="savePasswordBtn">Save Changes</button>
</div>
</div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
const performanceCtx = document.getElementById('performanceChart').getContext('2d');

fetch('/api/user/performance')
.then(response => response.json())
.then(data => {
const performanceChart = new Chart(performanceCtx, {
type: 'radar',
data: {
labels: data.subjects,
datasets: [{
label: 'Your Performance (%)',
data: data.scores,
backgroundColor: 'rgba(54, 162, 235, 0.2)',
borderColor: 'rgba(54, 162, 235, 1)',
borderWidth: 2,
pointBackgroundColor: 'rgba(54, 162, 235, 1)'
}]
},
options: {
scales: {
r: {
beginAtZero: true,
max: 100
}
}
}
});
})
.catch(error => {
console.error('Error fetching performance data:', error);
document.querySelector('.card-body').innerHTML = 
'<div class="alert alert-danger">Error loading performance data.</div>';
});

document.getElementById('savePasswordBtn').addEventListener('click', function() {
const currentPassword = document.getElementById('currentPassword').value;
const newPassword = document.getElementById('newPassword').value;
const confirmPassword = document.getElementById('confirmPassword').value;

if (newPassword !== confirmPassword) {
alert('New passwords do not match!');
return;
}

fetch('/api/user/change-password', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify({
current_password: currentPassword,
new_password: newPassword
})
})
.then(response => response.json())
.then(data => {
if (data.success) {
alert('Password changed successfully!');
const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
modal.hide();
document.getElementById('changePasswordForm').reset();
} else {
alert('Error: ' + data.message);
}
})
.catch(error => {
console.error('Error changing password:', error);
alert('An error occurred while changing password.');
});
});
});
</script>
{% endblock %}

